name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create Release ZIP
        run: |
          TAG_NAME="${{ github.ref_name }}"
          ZIP_NAME="dongliTV-$TAG_NAME.zip"
          echo "ğŸ“¦ åˆ›å»ºå‘å¸ƒåŒ…: $ZIP_NAME"
          git archive --format=zip HEAD -o "$ZIP_NAME"
          ls -lh "$ZIP_NAME"
          echo "RELEASE_ZIP=$ZIP_NAME" >> $GITHUB_ENV

      # æ ¸å¿ƒæ”¹å˜ï¼šä½¿ç”¨ GitHub API åˆ›å»º/æ›´æ–° version.json
      - name: Create or Update version.json via API
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG_NAME="${{ github.ref_name }}"
          JSON_CONTENT=$(cat <<EOF
          {
            "version": "$TAG_NAME",
            "url": "https://github.com/chitue/dongliTV/releases/download/$TAG_NAME/dongliTV-$TAG_NAME.zip",
            "notes": "https://github.com/chitue/dongliTV/releases/tag/$TAG_NAME"
          }
          EOF
          )
          
          # å¯¹JSONå†…å®¹è¿›è¡ŒBase64ç¼–ç ï¼ˆAPIè¦æ±‚ï¼‰
          CONTENT_B64=$(echo "$JSON_CONTENT" | base64 | tr -d '\n')
          
          # ä½¿ç”¨GitHub APIè·å–æ–‡ä»¶å½“å‰SHAï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          echo "è·å– version.json å½“å‰çŠ¶æ€..."
          API_RESPONSE=$(curl -s -H "Authorization: token $GH_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/contents/version.json" || echo '{}')
          
          SHA=$(echo "$API_RESPONSE" | grep -o '"sha": "[^"]*"' | cut -d'"' -f4)
          
          # æ„å»ºAPIè¯·æ±‚JSON
          API_JSON=$(cat <<EOF
          {
            "message": "chore: update version info to $TAG_NAME",
            "content": "$CONTENT_B64"
          }
          EOF
          )
          
          # å¦‚æœæ–‡ä»¶å·²å­˜åœ¨ï¼Œæ·»åŠ shaå­—æ®µç”¨äºæ›´æ–°
          if [ -n "$SHA" ]; then
            API_JSON=$(echo "$API_JSON" | jq --arg sha "$SHA" '. + {sha: $sha}')
          fi
          
          # åˆ›å»ºæˆ–æ›´æ–°æ–‡ä»¶
          echo "æäº¤ version.json åˆ°ä»“åº“..."
          curl -X PUT -H "Authorization: token $GH_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            -d "$API_JSON" \
            "https://api.github.com/repos/${{ github.repository }}/contents/version.json"
          echo "âœ… version.json å·²æ›´æ–°"

      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          generate_release_notes: true
          files: |
            ${{ env.RELEASE_ZIP }}